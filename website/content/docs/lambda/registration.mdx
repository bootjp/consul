---
layout: docs
page_title: Register Lambda Functions
description: >-
  This topic describes how to register AWS Lambda functions with Consul service mesh.
---

# Registration

Registering AWS Lambda functions into Consul requires:
1. Registering a service into Consul.
2. Writing a [service defaults configuration entry](/docs/connect/config-entries/service-defaults) for the Lambda.

To keep this configuration up to date, we recommend using the [Lambda registrator](https://github.com/hashicorp/terraform-aws-consul-lambda-registrator)
to automatically synchronize Lambda state into Consul. Lambda Registrator
automatically registers, reconfigures, and deregisters Lambdas based on the
[Lambda's tags](https://docs.aws.amazon.com/lambda/latest/dg/configuration-tags.html).

Lambdas can also be manually registered into Consul when using Lambda
registrator is not possible.

## Prerequisites

### Enable the Serverless Plugin

Lambda integration is only available in Consul 1.12.1 and later. It requires
including `connect { enable_serverless_plugin = true, connect = true }` in the
configuration for all Consul clients.

### Allow Envoy to Invoke the Lambda

The Envoy proxy that invokes Lambda must have the `lambda:InvokeFunction` AWS IAM
permissions to invoke the Lambda. The policy for invoking a Lambda will look
like the following:
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "Invoke",
            "Effect": "Allow",
            "Action": [
                "lambda:InvokeFunction"
            ],
            "Resource": "arn:aws:lambda:us-east-1:123456789012:function:example"
        }
    ]
}
```

AWS IAM credentials should be defined in environment variables, EC2 metadata or
ECS metadata. On [AWS EKS](https://aws.amazon.com/eks/), users must associate an IAM role with the proxy's
`ServiceAccount` by following [these
instructions](https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html).


### Optional: Run and Configure a Terminating Gateway

When invoking Lambda services through a [Terminating Gateway](/docs/connect/gateways#terminating-gateways), a terminating
gateway must be registered and running in the Consul datacenter. [This learn
guide](https://learn.hashicorp.com/tutorials/consul/terminating-gateways-connect-external-services)
describes how to manually set up a terminating gateway on VMs and [this
guide](/docs/k8s/connect/terminating-gateways) describes how to run one on
Kubernetes.

A Lambda service can be registered to a terminating gateway by adding it to the
`Services` field of the terminating gateway's `terminating-gateway`
configuration entry. See the [invocation page](/docs/lambda/invocation) for
more information about the ways Consul can invoke Lambdas.

### Optional: Run a Mesh Gateway

If a [mesh gateway](/docs/connect/gateways#mesh-gateways) will be used to invoke a Lambda service across admin
partitions or datacenters, a mesh gateway must be running and registered in
relevant Consul datacenters and partitions. [This learn
guide](https://learn.hashicorp.com/tutorials/consul/service-mesh-gateways)
describes how to manually set up a mesh gateway and [this learn
guide](https://learn.hashicorp.com/tutorials/consul/kubernetes-mesh-gateways?in=consul/kubernetes)
describes how to run one on Kubernetes.

When using admin partitions, Lambda services need to be added to the `Services`
field of [the `exported-services` configuration
entry](/docs/connect/config-entries/exported-services).

## Lambda Registrator

Lambda Registrator is responsible for automatically registering and
deregistering Lambdas into Consul based on [the Lambda's
tags](https://docs.aws.amazon.com/lambda/latest/dg/configuration-tags.html). It
runs as a Lambda function that is invoked by EventBridge in two ways:
- [CloudTrail Lambda
  events](https://docs.aws.amazon.com/lambda/latest/dg/logging-using-cloudtrail.html) - This syncs updates and deletes from Lambda into Consul in real-time.
    Typically, Lambda registrator syncs Lambdas into Consul within one minute,
    but CloudTrail events are occasionally delayed.
- [Schedules](https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-create-rule-schedule.html) - This periodically does a full sync between Lambda and Consul to prevent
  entropy. By default, EventBridge triggers a full sync every five minutes.


### Architecture

This diagram shows the flow of events from EventBridge into Consul:

<ImageConfig width={500}>

![Lambda Registrator Architecture](/img/lambda_registrator_architecture.svg)

</ImageConfig>

1. EventBridge invokes Lambda registrator. This is either done based on
   CloudTrail Lambda events or a schedule.
2. Lambda registrator determines how to reconcile Lambda's control plane state
   with Consul state and ensures they are in sync by registering, updating and
   deregistering Lambda services.

### Deploy Lambda Registrator

#### Deploy Lambda Registrator

Here is an example usage of the Lambda registrator terraform module:
```hcl
module "lambda-registrator" {
  source  = "hashicorp/consul-lambda-registrator/aws//modules/lambda-registrator"
  name = "consul-lambda-registrator"
  consul_http_addr = "https://consul.example.com:8501"
  ca_cert_path = aws_ssm_parameter.ca-cert.name
  http_token_path = aws_ssm_parameter.acl-token.name
}
```

Deploy Lambda registrator with `terraform apply`.

#### Optional: Store the CA Certificate in Parameter Store

When Consul making request to the [HTTP API](/api-docs) over HTTPS, Lambda
registrator uses a CA Certificate stored in Parameter Store. Consul’s Server CA
can be stored into Parameter Store by applying the following Terraform:

```hcl
resource "aws_ssm_parameter" "ca-cert" {
  name        = "/lambda-registrator/ca-cert"
  type        = "SecureString"
  value       = <VALUE>
}
```

#### Optional: Store the ACL Token in Parameter Store

When Consul has ACLs enabled, Lambda registrator uses an ACL token stored in
Parameter Store. This can be done with the CLI, API, or Terraform provider.
With the CLI, it is done by:
1. Write the following to rules.hcl:
```hcl
service_prefix "" {
  policy = "write"
}
```

2. Create the policy with `consul acl policy create -name "lambda-registrator-policy" -rules @rules.hcl`.
3. Create the token with `consul acl token create -policy-name "lambda-registrator-policy"`.
4. Store the token in Parameter Store by applying the following Terraform:
```hcl
resource "aws_ssm_parameter" "acl-token" {
  name        = "/lambda-registrator/acl-token"
  type        = "SecureString"
  value       = <VALUE>
}
```

#### Configuration Options

| Name | Type |  Description |
| - | - | - | - |
| `name` | Configuring AWS services | This is used to name Lambda registrator’s Lambda function and to construct the Identity and Access Management (IAM) role and policy names used by the Lambda function. |
| `schedule_frequency_in_minutes` | Configuring AWS services | The interval EventBridge uses to trigger a full synchronization. This defaults to 5 minutes. |
| `timeout` |Configuring AWS services | The maximum number of seconds Lambda registrator can run per invocation before timing out. |
| `consul_http_addr` | Runtime | This is directly used to configure the Consul API client. |
| `consul_ca_cert_path` | Runtime | This parameter only needs to be set when the Consul server is configured to use TLS. Its value is the AWS Parameter Store path to the CA Certificate for the Consul Cluster Lambda registrator uses. At startup, Lambda registrator pulls the CA Certificate at this path from Parameter Store, writes the certificate to the filesystem and stores the path of that file in `CONSUL_CACERT`. |
| `consul_http_token_path` | Runtime |  This parameter only needs to be set when the Consul server has ACLs enabled. Its value is an AWS Parameter Store path to the ACL Token Lambda registrator uses. It is used to fetch an ACL token from Parameter Store and is stored in the `CONSUL_HTTP_TOKEN` environment variable. |
| `node_name` | Runtime |  The Consul node name that Lambdas will be registered to. This defaults to "lambdas". |
| `enterprise` | Runtime |  <EnterpriseAlert inline />Determines if the Consul server at `consul_http_addr` is running open source or enterprise. |
| `partitions` | Runtime |  <EnterpriseAlert inline />The partitions that Lambda registrator manages. |

### Registering Lambdas

#### Overview

Lambda registrator registers Lambdas into Consul, no matter how they are
deployed, as long as they’re [tagged](https://docs.aws.amazon.com/lambda/latest/dg/configuration-tags.html) correctly. The following example uses
Terraform, but deploying a Lambda with CloudFormation, the AWS user
interface, and Cloud Development Kit (CDK) works too.

```hcl
resource "aws_lambda_function" "example" {
  …
  function_name = "lambda"
  tags = {
    "serverless.consul.hashicorp.com/v1alpha1/lambda/enabled" = "true"
    "serverless.consul.hashicorp.com/alpha/lambda/payload-passthrough" = "true"
    "serverless.consul.hashicorp.com/alpha/lambda/invocation-mode" = "ASYNCHRONOUS"
  }
}
```

#### Supported Tags

The following tags are supported. In all cases, the `<PREFIX>` should be
`serverless.consul.hashicorp.com/v1alpha1/lambda`. For example,
`serverless.consul.hashicorp.com/v1alpha1/lambda/enabled`.

| Tag | Description |
| - | - |
| `<PREFIX>/enabled` | Determines if Lambda registrator will sync the Lambda into Consul. |
| `<PREFIX>/payload-passthrough` | Determines if the body Envoy receives is converted to JSON or directly passed to Lambda. This attribute is optional and defaults to `false`. |
| `<PREFIX>/invocation-mode` | Specifies the [Lambda invocation mode](https://docs.aws.amazon.com/lambda/latest/operatorguide/invocation-modes.html) Consul uses to invoke the Lambda. This tag will default to `SYNCHRONOUS`, but also supports `ASYNCHRONOUS` invocations. |
| `<PREFIX>/namespace` | <EnterpriseAlert inline />This tag specifies the Consul namespace the service will be registered in. If `enterprise` is enabled on Lambda registrator, this defaults to `default`. |
| `<PREFIX>/partition` | <EnterpriseAlert inline />This tag specifies the Consul partition the service will be registered in. If `enterprise` is enabled on Lambda registrator, this defaults to `default`. |
| `<PREFIX>/aliases` | This tag specifies a `+`-separated string of Lambda aliases that will be registered into Consul. If this is set to `dev+staging+prod`, the `dev`, `staging`, and `prod` aliases of the Lambda function will be registered into Consul. |

## Manual Configuration

### Register the Service

`<SERVICE_NAME>` specifies the Consul service name for the Lambda function.
Replace `<SERVICE_NAME>` and store the following in `lambda.json`:
```json
{
  "Node": "lambdas",
  "SkipNodeUpdate": true,
  "NodeMeta": {
    "external-node": "true",
    "external-probe": "true"
  },
  "Service": {
    "Service": "<SERVICE_NAME>"
  }
}
```

Run `curl --request PUT --data @lambda.json localhost:8500/v1/catalog/register`
to register the service.

### Store the `service-defaults` Config Entry

Store the following in `lambda-service-defaults.hcl`:
```hcl
Kind = "service-defaults"
Name = "lambda"
Protocol  = "http"
Meta = {
  "serverless.consul.hashicorp.com/v1alpha1/lambda/enabled" = "true"
  "serverless.consul.hashicorp.com/v1alpha1/lambda/arn" = "<<INSERT ARN HERE>"
  "serverless.consul.hashicorp.com/v1alpha1/lambda/payload-passthroughgh" = "true"
  "serverless.consul.hashicorp.com/v1alpha1/lambda/region" = "us-east-2"
}
```

Store the configuration with `consul config write lambda-service-defaults.hcl`.

### Supported `Meta` Fields

The following tags are supported. In all cases, the `<PREFIX>` should be
`serverless.consul.hashicorp.com/v1alpha1/lambda`. For example,
`serverless.consul.hashicorp.com/v1alpha1/lambda/enabled`.

| Tag | Description |
| - | - |
| `<PREFIX>/enabled` | Determines if Consul configures the service as an AWS Lambda. |
| `<PREFIX>/payload-passthrough` | Determines if the body Envoy receives is converted to JSON or directly passed to Lambda. |
| `<PREFIX>/arn` | Specifies the [AWS ARN](https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html) for the service’s Lambda. |
| `<PREFIX>/invocation-mode` | Determines if Consul configures the Lambda to be invoked using the `synchronous` or `asynchronous` [invocation mode](https://docs.aws.amazon.com/lambda/latest/operatorguide/invocation-modes.html). |
| `<PREFIX>/region` | Specifies the AWS region the Lambda is running in. |
